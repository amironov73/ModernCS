### Что такое STA и MTA

Поток, который создает COM-объекты, должен сообщить COM-инфраструктуре, какую поддержку он хочет предоставить COM-классам, которые имеют ограничения по работе в многопоточной среде.

Подавляющее большинство этих классов поддерживают только так называемую Apartment Threading модель, их методы интерфейса могут быть безопасно вызваны из того же потока, который создал экземпляр. Другими словами, они объявляют: «Я не поддерживаю многопоточность, пожалуйста, позаботьтесь о том, чтобы никогда не вызывать меня из неправильного потока».

Существует два вида: STA (Single Threaded Apartment) и MTA. Он указан в вызове CoInitializeEx () - функции, которую должен вызывать любой поток, который делает что-либо с COM. CLR автоматически выполняет этот вызов при каждом запуске потока. Для основного потока запуска вашей программы он получает значение для перехода от атрибута [STAThread] или [MTAThread] в свой метод Main (). По умолчанию используется MTA. Для потоков, которые вы создаете самостоятельно, это определяется вашим вызовом SetApartmentState (). По умолчанию используется MTA. Потоки из пула всегда являются MTA, и это нельзя изменить.

В Windows много кода, для которого требуется STA. Известными примерами являются буфер обмена, Drag + Drop и диалоговые окна оболочки (например, OpenFileDialog). Поток пользовательского интерфейса проекта WPF или Windows Forms всегда должен быть STA, как и любой поток, который создает окно.

Обещание, которое вы даёте COM, что ваша нить STA, однако, требует от вас следовать однопоточному договору. Он довольно жесткий, и при его нарушении вы можете получить довольно трудно диагностируемые проблемы. Требования таковы: вы никогда не блокируете поток в течение какого-либо времени и что вы отказываетесь от цикла сообщений. Последнее требование выполняется WPF или WinForms UI thread, но вам нужно будет позаботиться о нем самостоятельно, если вы создадите свой собственный поток STA.

Существует небольшая поддержка CLR для этих требований, что помогает избежать проблем. Например, оператор блокировки будет перекачивать контур сообщения, когда он блокирует поток STA. Большинство классов синхронизации делают также, Mutex является заметным исключением. Это, однако, только заботится о никогда-блочном требовании, вам все равно нужно создать свой собственный цикл сообщений. Application.Run () как в WPF, так и в Winforms.
