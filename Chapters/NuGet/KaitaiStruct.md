### Kaitai Struct

–ß–∏—Ç–∞—Ç—å-–ø–∏—Å–∞—Ç—å –¥–≤–æ–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–æ–≤–æ–ª—å–Ω–æ –º–æ—Ä–æ—á–Ω–æ, –æ—Å–æ–±–µ–Ω–Ω–æ, –µ—Å–ª–∏ —ç—Ç–æ —Ñ–æ—Ä–º–∞—Ç –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏, –∏ –æ–Ω –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º. [–ü—Ä–æ–µ–∫—Ç Kaitai Struct](https://kaitai.io/) –ø—Ä–∏–∑–≤–∞–Ω —É–ø—Ä–æ—Å—Ç–∏—Ç—å —ç—Ç—É —Ä–∞–±–æ—Ç—É. –ù—É–∂–Ω–æ –≤—Å–µ–≥–æ –ª–∏—à—å –æ–ø–∏—Å–∞—Ç—å –¥–≤–æ–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –∏ —Ç–æ–≥–¥–∞ –∫–∞–∂–¥—ã–π —Å–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –Ω–∞ —Å–≤–æ—ë–º —è–∑—ã–∫–µ –∏ –Ω–∞ —Å–≤–æ–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ.

–ò–¥–µ—è –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç –æ–ø–∏—Å—ã–≤–∞—é—Ç –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º —è–∑—ã–∫–µ Kaitai Struct (—Ñ–∞–π–ª .ksy), –∞ –∑–∞—Ç–µ–º –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç —Å –ø–æ–º–æ—â—å—é kaitai struct compiler –≤ –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –≠—Ç–∏ –º–æ–¥—É–ª–∏ –±—É–¥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Å—á–∏—Ç—ã–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ / –ø–æ—Ç–æ–∫–∞ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –¥–æ—Å—Ç—É–ø –∫ –Ω–µ–π –≤ —É–¥–æ–±–Ω–æ–º –∏ –ø–æ–Ω—è—Ç–Ω–æ–º API.

–†–∞–±–æ—Ç–∞ —Å Kaitai Struct –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –û–ø–∏—Å–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç, —Ç. –µ. —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª .ksy.
2. –° –ø–æ–º–æ—â—å—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–µ—Ä–Ω–æ.
3. –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª .ksy –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª —Ü–µ–ª–µ–≤–æ–≥–æ —è–∑—ã–∫–∞ –∏ –≤–∫–ª—é—á–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç.
4. –ü–æ–¥–∫–ª—é—á–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Kaitai Struct –∫ —Å–≤–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É.
5.–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö.

–ü—Ä–æ–π–¥—ë–º—Å—è –ø–æ —à–∞–≥–∞–º –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ GIF ‚Äì —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–≤–∏–∂—É—â–∏—Ö—Å—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç. –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —è–∑—ã–∫–µ Kaitai –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```yaml
meta:
  id: gif
  file-extension: gif
  endian: le
seq:
  - id: header
    type: header
  - id: logical_screen
    type: logical_screen
types:
  header:
    seq:
      - id: magic
        contents: 'GIF'
      - id: version
        size: 3
  logical_screen:
    seq:
      - id: image_width
        type: u2
      - id: image_height
        type: u2
      - id: flags
        type: u1
      - id: bg_color_index
        type: u1
      - id: pixel_aspect_ratio
        type: u1
```

–û–±—ã—á–Ω—ã–π YAML. –¢—É—Ç –¥–∞–∂–µ –ø–æ—è—Å–Ω—è—Ç—å –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–¥–æ, –Ω–∞—Å—Ç–æ–ª—å–∫–æ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. üôÇ

–î–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ KSY-—Ñ–∞–π–ª–æ–≤ –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è [Web IDE](https://ide.kaitai.io/)

![web ide](img/kaitai-web-ide.png)

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –Ω–∞ OS X –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –≤–æ–ª—à–µ–±–Ω–æ–º –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–∏, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ —Å–∞–º–æ —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è, –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ –ø–∞–ø–∫—É `/usr/local/Cellar/kaitai-struct-compiler/0.8_1`:

```
brew install kaitai-struct-compiler
```

–ö–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞:

```
kaitai-struct-compiler [options] <file>
```

–û–ø—Ü–∏–∏

* `<file>`‚Äã ‚Äî –∏—Å—Ö–æ–¥–Ω—ã–π KSY-—Ñ–∞–π–ª
* `-t <language>` | `--target <language>` ‚Äî —è–∑—ã–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (cpp_stl, csharp, java, javascript, perl, php, python, ruby, all)
  * all —Å–≥–µ–Ω–µ–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —è–∑—ã–∫–æ–≤
* `-d <directory>` | `--outdir <directory>` ‚Äî –≤—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (–∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —è–∑—ã–∫–∞ –æ–ø—Ü–∏–∏:

* `--dotnet-namespace <namespace>` ‚Äî –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º—ë–Ω –¥–ª—è .NET (—Ç–æ–ª—å–∫–æ –¥–ª—è C#, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: Kaitai)
* `--java-package <package>` ‚Äî –ø–∞–∫–µ—Ç Java (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–∫–µ—Ç)
* `--php-namespace <namespace>` ‚Äî –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º—ë–Ω PHP (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ–∑ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º—ë–Ω)

–ü—Ä–æ—á–∏–µ –æ–ø—Ü–∏–∏:

* `--verbose` ‚Äî ¬´–±–æ–ª—Ç–ª–∏–≤—ã–π¬ª —Ä–µ–∂–∏–º
* `--help` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è
* `--version` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è

–î–ª—è –≤—ã—à–µ–ø—Ä–∏–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è GIF –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–ª–µ–¥—É—é—â–∏–π Java-—Ñ–∞–π–ª:

```java
// This is a generated file! Please edit source .ksy file and use kaitai-struct-compiler to rebuild
 
import io.kaitai.struct.ByteBufferKaitaiStream;
import io.kaitai.struct.KaitaiStruct;
import io.kaitai.struct.KaitaiStream;
import java.io.IOException;
 
public class Gif extends KaitaiStruct {
    public static Gif fromFile(String fileName) throws IOException {
        return new Gif(new ByteBufferKaitaiStream(fileName));
    }
 
    public Gif(KaitaiStream _io) {
        this(_io, null, null);
    }
 
    public Gif(KaitaiStream _io, KaitaiStruct _parent) {
        this(_io, _parent, null);
    }
 
    public Gif(KaitaiStream _io, KaitaiStruct _parent, Gif _root) {
        super(_io);
        this._parent = _parent;
        this._root = _root == null ? this : _root;
        _read();
    }
    private void _read() {
        this.header = new Header(this._io, this, _root);
        this.logicalScreen = new LogicalScreen(this._io, this, _root);
    }
    public static class Header extends KaitaiStruct {
        public static Header fromFile(String fileName) throws IOException {
            return new Header(new ByteBufferKaitaiStream(fileName));
        }
 
        public Header(KaitaiStream _io) {
            this(_io, null, null);
        }
 
        public Header(KaitaiStream _io, Gif _parent) {
            this(_io, _parent, null);
        }
 
        public Header(KaitaiStream _io, Gif _parent, Gif _root) {
            super(_io);
            this._parent = _parent;
            this._root = _root;
            _read();
        }
        private void _read() {
            this.magic = this._io.ensureFixedContents(new byte[] { 71, 73, 70 });
            this.version = this._io.readBytes(3);
        }
        private byte[] magic;
        private byte[] version;
        private Gif _root;
        private Gif _parent;
        public byte[] magic() { return magic; }
        public byte[] version() { return version; }
        public Gif _root() { return _root; }
        public Gif _parent() { return _parent; }
    }
    public static class LogicalScreen extends KaitaiStruct {
        public static LogicalScreen fromFile(String fileName) throws IOException {
            return new LogicalScreen(new ByteBufferKaitaiStream(fileName));
        }
 
        public LogicalScreen(KaitaiStream _io) {
            this(_io, null, null);
        }
 
        public LogicalScreen(KaitaiStream _io, Gif _parent) {
            this(_io, _parent, null);
        }
 
        public LogicalScreen(KaitaiStream _io, Gif _parent, Gif _root) {
            super(_io);
            this._parent = _parent;
            this._root = _root;
            _read();
        }
        private void _read() {
            this.imageWidth = this._io.readU2le();
            this.imageHeight = this._io.readU2le();
            this.flags = this._io.readU1();
            this.bgColorIndex = this._io.readU1();
            this.pixelAspectRatio = this._io.readU1();
        }
        private int imageWidth;
        private int imageHeight;
        private int flags;
        private int bgColorIndex;
        private int pixelAspectRatio;
        private Gif _root;
        private Gif _parent;
        public int imageWidth() { return imageWidth; }
        public int imageHeight() { return imageHeight; }
        public int flags() { return flags; }
        public int bgColorIndex() { return bgColorIndex; }
        public int pixelAspectRatio() { return pixelAspectRatio; }
        public Gif _root() { return _root; }
        public Gif _parent() { return _parent; }
    }
    private Header header;
    private LogicalScreen logicalScreen;
    private Gif _root;
    private KaitaiStruct _parent;
    public Header header() { return header; }
    public LogicalScreen logicalScreen() { return logicalScreen; }
    public Gif _root() { return _root; }
    public KaitaiStruct _parent() { return _parent; }
}
```

–î–ª—è C# –±—ã–ª–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:

```c#
// This is a generated file! Please edit source .ksy file and use kaitai-struct-compiler to rebuild
 
namespace Kaitai
{
    public partial class Gif : KaitaiStruct
    {
        public static Gif FromFile(string fileName)
        {
            return new Gif(new KaitaiStream(fileName));
        }
 
        public Gif(KaitaiStream p__io, KaitaiStruct p__parent = null, Gif p__root = null) : base(p__io)
        {
            m_parent = p__parent;
            m_root = p__root ?? this;
            _read();
        }
        private void _read()
        {
            _header = new Header(m_io, this, m_root);
            _logicalScreen = new LogicalScreen(m_io, this, m_root);
        }
        public partial class Header : KaitaiStruct
        {
            public static Header FromFile(string fileName)
            {
                return new Header(new KaitaiStream(fileName));
            }
 
            public Header(KaitaiStream p__io, Gif p__parent = null, Gif p__root = null) : base(p__io)
            {
                m_parent = p__parent;
                m_root = p__root;
                _read();
            }
            private void _read()
            {
                _magic = m_io.EnsureFixedContents(new byte[] { 71, 73, 70 });
                _version = m_io.ReadBytes(3);
            }
            private byte[] _magic;
            private byte[] _version;
            private Gif m_root;
            private Gif m_parent;
            public byte[] Magic { get { return _magic; } }
            public byte[] Version { get { return _version; } }
            public Gif M_Root { get { return m_root; } }
            public Gif M_Parent { get { return m_parent; } }
        }
        public partial class LogicalScreen : KaitaiStruct
        {
            public static LogicalScreen FromFile(string fileName)
            {
                return new LogicalScreen(new KaitaiStream(fileName));
            }
 
            public LogicalScreen(KaitaiStream p__io, Gif p__parent = null, Gif p__root = null) : base(p__io)
            {
                m_parent = p__parent;
                m_root = p__root;
                _read();
            }
            private void _read()
            {
                _imageWidth = m_io.ReadU2le();
                _imageHeight = m_io.ReadU2le();
                _flags = m_io.ReadU1();
                _bgColorIndex = m_io.ReadU1();
                _pixelAspectRatio = m_io.ReadU1();
            }
            private ushort _imageWidth;
            private ushort _imageHeight;
            private byte _flags;
            private byte _bgColorIndex;
            private byte _pixelAspectRatio;
            private Gif m_root;
            private Gif m_parent;
            public ushort ImageWidth { get { return _imageWidth; } }
            public ushort ImageHeight { get { return _imageHeight; } }
            public byte Flags { get { return _flags; } }
            public byte BgColorIndex { get { return _bgColorIndex; } }
            public byte PixelAspectRatio { get { return _pixelAspectRatio; } }
            public Gif M_Root { get { return m_root; } }
            public Gif M_Parent { get { return m_parent; } }
        }
        private Header _header;
        private LogicalScreen _logicalScreen;
        private Gif m_root;
        private KaitaiStruct m_parent;
        public Header header { get { return _header; } }
        public LogicalScreen logicalScreen { get { return _logicalScreen; } }
        public Gif M_Root { get { return m_root; } }
        public KaitaiStruct M_Parent { get { return m_parent; } }
    }
}
```

–ö–∞–∫ –≥–æ–≤–æ—Ä–∏—Ç—Å—è, —á—Ç–æ —Å–æ–≤–æ–π –æ–± –ø–µ–Ω—å, —á—Ç–æ –ø–Ω—ë–º –æ–± —Å–æ–≤—É ‚Äì —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π. –ù–æ –ª–∏—á–Ω–æ –º–Ω–µ –±–æ–ª—å—à–µ –Ω—Ä–∞–≤–∏—Ç—Å—è C#, —Ç–∞–∫ —á—Ç–æ –≤—ã–±–µ—Ä–µ–º –µ–≥–æ. –ü–æ–ø—Ä–æ–±—É–µ–º —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–µ –∫–æ–Ω—Å–æ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ .NET Core –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã GIF-—Ñ–∞–π–ª–∞:

```
mkdir KaitaiApp
cd KaitaiApp
dotnet new console
dotnet add package KaitaiStruct.Runtime.CSharp
```

–ü–∏—à–µ–º Program.cs —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è:

```c#
using System;
using Kaitai;
 
namespace KaitaiApp
{
    class Program
    {
        static void Main(string[] args)
        {
            Gif g = Gif.FromFile("earth.gif");
 
            Console.WriteLine("width = " + g.logicalScreen.ImageWidth);
            Console.WriteLine("height = " + g.logicalScreen.ImageHeight);
        }
    }
}
```

–ö–ª–∞–¥—ë–º —Ä—è–¥–æ–º earth.gif, –ø–æ–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã–π —É –í–∏–∫–∏–ø–µ–¥–∏–∏, –∑–∞–ø—É—Å–∫–∞–µ–º –∏ –≤–∏–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

![run kaitai](img/kaitai-run.png)

GitHub –ø—Ä–æ–µ–∫—Ç–∞: https://github.com/kaitai-io/kaitai_struct, NuGet: https://www.nuget.org/packages/KaitaiStruct.Runtime.CSharp/

#### –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä

–ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ Ruby –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–∞–∫:

```
sudo gem install kaitai-struct-visualizer
```

–ö–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –≤—ã–∑–æ–≤–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞:

```
ksv earth.gif gif.ksy
```

![visualizer](img/kaitai-visualizer.png)
